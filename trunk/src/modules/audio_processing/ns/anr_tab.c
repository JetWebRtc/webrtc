/*****************************************************************/
/* DITECH NETWORKS INC.						                     */
/* Copyright. 2006. Ditech Networks Inc. All rights reserved.	 */
/*---------------------------------------------------------------*/
/* C Code Module for StarCore DSP (SC140/3400)/TMS320C54x        */
/*                                                               */
/* File Name       : anr_tab.c                                   */
/* Author          : Chunyan Li, JB Hong, M Godavarti            */
/* Date            : Aug/12/2006                                 */
/*---------------------------------------------------------------*/
/* Revision History:                                             */
/*   $Revision: 1.00 $ (NOV/06/2002) by Chunyan Li               */
/*              file created                                     */
/*   $Revision: 1.50 $ (AUG/12/2006) by JB HONG                  */
/*              Polished/refined codes for Freescale SC140.      */
/*   $Revision: 2.00 $ (MAY/21/2007) by JB HONG & M Godavarti    */
/*              Anysis/Synthesis windowing changed.              */
/*****************************************************************/
#include  "anr_vad.h"
//#include "anr_const_JB.h"

// configurable SNR adaptive ANC -- max SNR table
const int	anr_max_snr_tab[4] =
{
    18,	// 18dB
    24,	// 24dB
    30,	// 30dB, default
    36	// 36dB
};

// Configurable Confort noise floor value

const FLOAT	anr_cng_thr_flt_tab[4] =
{
    (F)-55.0,		 // dummy for CNF disable
    (F)-46.0,		 // -43dBm
    (F)-55.0,        // -49dBm default
    (F)-61.0		 // -55dBm (-61dBov)
};

// noise level correspond to dB attenuation, 0 -- -21dB
const FLOAT anr_Tbl_noise_level_flt[ANR_NOISE_LEVEL_RANGE+1] =
{
    (F)1.0,//32767,  // 0dB
    (F)0.890625,//29184,
    (F)0.793945,//26016,
    (F)0.707031,//23168,
    (F)0.621093,//20352,
    (F)0.561523,//18400,
    (F)0.500976,//16416,  // 6dB
    (F)0.446289,//14624,
    (F)0.397460,//13024,
    (F)0.274658,//9000,   //9dB
    (F)0.274658,//9000,   // -10
    (F)0.274658,//9000,   // -11
    (F)0.213623,//7000,   // -12
    (F)0.213623,//7000,   // -13
    (F)0.199218,//6528,   // -14
    (F)0.152587,//5000,   // -15
    (F)0.152587,//5000,   // -16
    (F)0.140625,//4608,   // -17
    (F)0.100006,//3277,   // -18
    (F)0.100006,//3277,   // -19
    (F)0.091552,//3000,   // -20
    (F)0.067138,//2200    // -21
};



// added anr_cfg_tab[] by chunyan @ 4/16/2003
const FLOAT anr_cfg_tab_flt[6] =
{
	NOISE_LEVEL_21dB,
	NOISE_LEVEL_18dB,
	NOISE_LEVEL_15dB,
	NOISE_LEVEL_12dB,
	NOISE_LEVEL_9dB,
	NOISE_LEVEL_6dB		// add 6dB configuration
};

const int cband1[2*NC] =
{
  //0,   3,
    4,   6,
    7,   10,
    11,  13,
    14,  16,
    17,  20,
    21,  25,
    26,  29,
    30,  35,
    36,  41,
    42,  47,
    48,  55,
    56,  64,
    65,  74,
    75,  86,
    87,  100,
    101, 118,
    119, 128
};

const float	cband1_log_offset_flt[NC] =
{ //log10(32/(c2-c1+1)) 
  //(F)0.903089,
    (F)1.028028,
    (F)0.903089,
    (F)1.028028,
	(F)1.028028,
    (F)0.903089,
    (F)0.806179,
    (F)0.903089,
    (F)0.726998,
    (F)0.726998,
    (F)0.726998,
    (F)0.602059,
    (F)0.550907,
	(F)0.505149,
    (F)0.425968,
    (F)0.359021,
    (F)0.249877,
    (F)0.505149
};

const float cband1_div_flt[NC] =
{ //32768/(C2-C1+1)
  //0.25,
    (F)0.333343,
    (F)0.25,
    (F)0.333343,
    (F)0.333343,
    (F)0.25,
    (F)0.200012,
    (F)0.25,
    (F)0.166656,
    (F)0.166656,
    (F)0.166656,
    (F)0.125,
    (F)0.111114,
    (F)0.100006, 
    (F)0.083343,
    (F)0.071441,
    (F)0.055541,
    (F)0.100006
};
const int cband[2*NUM_CRITICAL_BAND] =
{
    0,   3,
    4,   6,
    7,   10,
    11,  13,
    14,  16,
    17,  20,
    21,  25,
    26,  29,
    30,  35,
    36,  41,
    42,  47,
    48,  55,
    56,  64,
    65,  74,
    75,  86,
    87,  100,
    101, 118,
    119, 128
};

const Word32 cband_log_offset[NUM_CRITICAL_BAND] =
{ //log10(32/(c2-c1+1)) in Q.26
    60605343,
    68989839,
    60605343,
    68989839,
    68989839,
    60605343,
    54101822,
    60605343,
    48788058,
    48788058,
    48788058,
    40403562,
    36970774,
    33900041,
    28586277,
    24093554,
    16768993,
    33900041
};

const FLOAT cband_div_flt[NUM_CRITICAL_BAND] =
{// 32768/(C2-C1+1)
    (F)0.25,//8192,
    (F)0.333343,//10923,
    (F)0.25,//8192,
    (F)0.333343,//10923,
    (F)0.333343,//10923,
    (F)0.25,//8192,
    (F)0.200012,//6554,
    (F)0.25,//8192,
    (F)0.166656,//5461,
    (F)0.166656,//5461,
    (F)0.166656,//5461,
    (F)0.125,//4096,
    (F)0.111114,//3641,
    (F)0.100006,//3277, //3641,
    (F)0.083343,//2731,
    (F)0.071441,//2341,
    (F)0.055541,//1820,
    (F)0.100006 //3277
};

const int Roffset[NUM_CRITICAL_BAND] =
{
   -16, -17,
   -18, -19,
   -20, -21,
   -22, -23,
   -24, -25,
   -25, -25,
   -25, -25,
   -25,
   -24, -23, -22
// -23, -22, -21
};

const FLOAT Tnorm_flt[NUM_CRITICAL_BAND] =
{
    (F)0.65625,
    (F)1.859375,
    (F)2.023437,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.042968,
    (F)2.039062,
    (F)1.574218
}	;


/* VAD2 */
const int v_array[90] =
{
    2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
    3, 3, 3, 3, 3,
    4, 4, 4,
    5, 5, 5,
    6, 6,
    7, 7, 7,
    8, 8,
    9, 9,
    10, 10,
    11,
    12, 12,
    13, 13,
    14,
    15, 15,
    16,
    17, 17,
    18,
    19,
    20, 20,
    21,
    22,
    23,
    24, 24,
    25,
    26,
    27,
    28, 28,
    29,
    30,
    31,
    32,
    33,
    34,
    35,
    36,
    37, 37,
    38,
    39,
    40,
    41,
    42,
    43,
    44,
    45,
    46,
    47,
    48,
    49,
    50, 50, 50, 50, 50, 50, 50, 50, 50, 50
};

//------------------------------------------------------
// Spreading function
//------------------------------------------------------
//	S(x) = 15.81+7.5*(x+0.474)-17.5*sqrt(1+(x+0.474)^2)
//	SF(i,j)=power(10, S(i-j)/10)
//	0<=i, j<=17
//
//	SF[i,j] = Table_SF[NUM_CRITICAL_BAND-1+i-j] in Q.15
//------------------------------------------------------
#if 0
const FLOAT Table_SF_flt[2*NUM_CRITICAL_BAND-1] =
{
    (F)0.0,			//-17
    (F)0.0,			//-16
    (F)0.0,			//-15
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,
    (F)0.0,   	   //-4
    (F)0.000008,   //-3
    (F)0.001752,   //-2
    (F)0.161872,   //-1
    (F)0.999680,   //0
    (F)0.371021,   //1
    (F)0.058438,   //2
    (F)0.007246,   //3
    (F)0.000819,   //4
    (F)0.000088,   //5
    (F)0.000009,   //6
    (F)0.000000    //7
    (F)0.000000    //8
    (F)0.000000,   //9
    (F)0.000000,   //10
    (F)0.000000,   //11
    (F)0.0,        //12
    (F)0.0,        //13
    (F)0.0,        //14
    (F)0.0,        //15
    (F)0.0,        //16
    (F)0.0         //17
};
#else
const FLOAT Table_SF_flt[8] =
{
    (F)0.001752,	//-2
    (F)0.161872,	//-1
    (F)0.999680,	//0
    (F)0.371021,	//1
    (F)0.058438,	//2
    (F)0.007246,	//3
    (F)0.000820,	//4
    (F)0.000090 	//5
} ;

#endif

#if ZERO_PADDING_IN_FFT

const FLOAT tri_win_flt[OLP_SIZE+1]=
{
   (F)0.000000,  (F)0.024993,  (F)0.049987,  (F)0.075012,
   (F)0.100006,  (F)0.125000,  (F)0.149993,  (F)0.174987,
   (F)0.200012,  (F)0.225006,  (F)0.250000,  (F)0.274993,
   (F)0.299987,  (F)0.325012,  (F)0.350006,  (F)0.375000,
   (F)0.399993,  (F)0.424987,  (F)0.450012,  (F)0.475006,
   (F)0.500000,  (F)0.524993,  (F)0.549987,  (F)0.575012,
   (F)0.600006,  (F)0.625000,  (F)0.649993,  (F)0.674987,
   (F)0.700012,  (F)0.725006,  (F)0.750000,  (F)0.774993,
   (F)0.799987,  (F)0.825012,  (F)0.850006,  (F)0.875000,
   (F)0.899993,  (F)0.924987,  (F)0.950012,  (F)0.975006,
   (F)0.999969  
};


#else


/*---------------------------------------------------------------*/
/* Triangular Window                                             */
/*   tri_win[i] = (i+1)/N*2^15  ;; //N=128=FFTLENGTH/2           */
/*                     i = 0,1,2,...N-1                          */
/*---------------------------------------------------------------*/

const FLOAT tri_win_flt[FFTLENGTH/2] =
{

	(F)0.007813,	(F)0.015625,	(F)0.023438,	(F)0.031250,	
	(F)0.039063,	(F)0.046875,	(F)0.054688,	(F)0.062500,	
	(F)0.070313,	(F)0.078125,	(F)0.085938,	(F)0.093750,	
	(F)0.101563,	(F)0.109375,	(F)0.117188,	(F)0.125000,	
	(F)0.132813,	(F)0.140625,	(F)0.148438,	(F)0.156250,	
	(F)0.164063,	(F)0.171875,	(F)0.179688,	(F)0.187500,	
	(F)0.195313,	(F)0.203125,	(F)0.210938,	(F)0.218750,	
	(F)0.226563,	(F)0.234375,	(F)0.242188,	(F)0.250000,	
	(F)0.257813,	(F)0.265625,	(F)0.273438,	(F)0.281250,	
	(F)0.289063,	(F)0.296875,	(F)0.304688,	(F)0.312500,	
	(F)0.320313,	(F)0.328125,	(F)0.335938,	(F)0.343750,	
	(F)0.351563,	(F)0.359375,	(F)0.367188,	(F)0.375000,	
	(F)0.382813,	(F)0.390625,	(F)0.398438,	(F)0.406250,	
	(F)0.414063,	(F)0.421875,	(F)0.429688,	(F)0.437500,	
	(F)0.445313,	(F)0.453125,	(F)0.460938,	(F)0.468750,	
	(F)0.476563,	(F)0.484375,	(F)0.492188,	(F)0.500000,	
	(F)0.507813,	(F)0.515625,	(F)0.523438,	(F)0.531250,	
	(F)0.539063,	(F)0.546875,	(F)0.554688,	(F)0.562500,	
	(F)0.570313,	(F)0.578125,	(F)0.585938,	(F)0.593750,	
	(F)0.601563,	(F)0.609375,	(F)0.617188,	(F)0.625000,	
	(F)0.632813,	(F)0.640625,	(F)0.648438,	(F)0.656250,	
	(F)0.664063,	(F)0.671875,	(F)0.679688,	(F)0.687500,	
	(F)0.695313,	(F)0.703125,	(F)0.710938,	(F)0.718750,	
	(F)0.726563,	(F)0.734375,	(F)0.742188,	(F)0.750000,	
	(F)0.757813,	(F)0.765625,	(F)0.773438,	(F)0.781250,	
	(F)0.789063,	(F)0.796875,	(F)0.804688,	(F)0.812500,	
	(F)0.820313,	(F)0.828125,	(F)0.835938,	(F)0.843750,	
	(F)0.851563,	(F)0.859375,	(F)0.867188,	(F)0.875000,	
	(F)0.882813,	(F)0.890625,	(F)0.898438,	(F)0.906250,	
	(F)0.914063,	(F)0.921875,	(F)0.929688,	(F)0.937500,	
	(F)0.945313,	(F)0.953125,	(F)0.960938,	(F)0.968750,	
	(F)0.976563,	(F)0.984375,	(F)0.992188,	(F)0.999969	
};

#if ANR_20ms 

    /* ============= 20ms undo windows =========== */
	/*---------------------------------------------------*/
	/* undo_plus_tri_win[i]                              */
	/*   = 1/tri_win[56+i] * i/39 ;; N=128        */
    /*          i = 0,1,2...39                           */
	/*---------------------------------------------------*/

const FLOAT undo_plus_tri_win_flt[LOOK_AHEAD] =
{
	(F)0.000000,	(F)0.056587,	(F)0.111256,	(F)0.164103,	
	(F)0.215216,	(F)0.264682,	(F)0.312576,	(F)0.358974,	
	(F)0.403944,	(F)0.447552,	(F)0.489858,	(F)0.530920,	
	(F)0.570791,	(F)0.609524,	(F)0.647164,	(F)0.683761,	
	(F)0.719353,	(F)0.753985,	(F)0.787692,	(F)0.820513,	
	(F)0.852480,	(F)0.883629,	(F)0.913988,	(F)0.943590,	
	(F)0.972459,	(F)1.000625,	(F)1.028112,	(F)1.054945,	
	(F)1.081146,	(F)1.106738,	(F)1.131741,	(F)1.156177,	
	(F)1.180063,	(F)1.203419,	(F)1.226260,	(F)1.248606,	
	(F)1.270471,	(F)1.291871,	(F)1.312820,	(F)1.333333	
};

	/*-----------------------------------------------------*/
	/* undo_win[i] = 1/tri_win[56+40+i] ;; N=128		   */
	/*       for i = 0,1,2...31 (first 32 samples)         */
	/* undo_win[i] = 1/tri_win[127-i] ;; N=128			   */
	/*       for i = 0,1,2,...87 (last 88 samples)         */
	/*    TOTAL 120 samples                                */
	/*-----------------------------------------------------*/
	
const FLOAT undo_win_flt[FRAME_SIZE-OLP_SIZE] =
{
	(F)1.319587,	(F)1.306122,	(F)1.292928,	(F)1.280000,	
	(F)1.267326,	(F)1.254902,	(F)1.242718,	(F)1.230769,	
	(F)1.219047,	(F)1.207547,	(F)1.196261,	(F)1.185185,	
	(F)1.174311,	(F)1.163636,	(F)1.153153,	(F)1.142857,	
	(F)1.132743,	(F)1.122807,	(F)1.113043,	(F)1.103448,	
	(F)1.094017,	(F)1.084746,	(F)1.075630,	(F)1.066667,	
	(F)1.057851,	(F)1.049180,	(F)1.040650,	(F)1.032258,	
	(F)1.024000,	(F)1.015873,	(F)1.007874,	(F)1.000031,	
	(F)1.000031,	(F)1.007874,	(F)1.015873,	(F)1.024000,	
	(F)1.032258,	(F)1.040650,	(F)1.049180,	(F)1.057851,	
	(F)1.066667,	(F)1.075630,	(F)1.084746,	(F)1.094017,	
	(F)1.103448,	(F)1.113043,	(F)1.122807,	(F)1.132743,	
	(F)1.142857,	(F)1.153153,	(F)1.163636,	(F)1.174311,	
	(F)1.185185,	(F)1.196261,	(F)1.207547,	(F)1.219047,	
	(F)1.230769,	(F)1.242718,	(F)1.254902,	(F)1.267326,	
	(F)1.280000,	(F)1.292928,	(F)1.306122,	(F)1.319587,	
	(F)1.333333,	(F)1.347368,	(F)1.361702,	(F)1.376343,	
	(F)1.391304,	(F)1.406592,	(F)1.422222,	(F)1.438201,	
	(F)1.454545,	(F)1.471263,	(F)1.488372,	(F)1.505881,	
	(F)1.523810,	(F)1.542168,	(F)1.560976,	(F)1.580246,	
	(F)1.600000,	(F)1.620252,	(F)1.641026,	(F)1.662336,	
	(F)1.684211,	(F)1.706665,	(F)1.729730,	(F)1.753423,	
	(F)1.777778,	(F)1.802815,	(F)1.828571,	(F)1.855071,	
	(F)1.882353,	(F)1.910446,	(F)1.939394,	(F)1.969229,	
	(F)2.000000,	(F)2.031744,	(F)2.064516,	(F)2.098358,	
	(F)2.133333,	(F)2.169489,	(F)2.206897,	(F)2.245611,	
	(F)2.285714,	(F)2.327270,	(F)2.370370,	(F)2.415091,	
	(F)2.461538,	(F)2.509801,	(F)2.560000,	(F)2.612241,	
	(F)2.666667,	(F)2.723400,	(F)2.782609,	(F)2.844440,	
	(F)2.909091,	(F)2.976740,	(F)3.047619,	(F)3.121946	
};

#else
    /* ======  10ms undo windows ========= */
	/*---------------------------------------------------*/
	/* undo_plus_tri_win[i]                              */
	/*   = 1/tri_win[119-i]* i/39 * 2^14 ;; N=128        */
	/*          i = 0,1,..39                             */
	/*---------------------------------------------------*/

const FLOAT undo_plus_tri_win_flt[OLP_SIZE] =
{
	(F)0.000000,	(F)0.027588,	(F)0.055603,	(F)0.084167,	
	(F)0.113159,	(F)0.142700,	(F)0.172729,	(F)0.203308,	
	(F)0.234436,	(F)0.266113,	(F)0.298340,	(F)0.331238,	
	(F)0.364685,	(F)0.398743,	(F)0.433472,	(F)0.468872,	
	(F)0.504944,	(F)0.541687,	(F)0.579163,	(F)0.617432,	
	(F)0.656433,	(F)0.696167,	(F)0.736816,	(F)0.778198,	
	(F)0.820496,	(F)0.863708,	(F)0.907776,	(F)0.952881,	
	(F)0.998901,	(F)1.045898,	(F)1.093994,	(F)1.143188,	
	(F)1.193481,	(F)1.244934,	(F)1.297546,	(F)1.351440,	
	(F)1.406616,	(F)1.463074,	(F)1.520935,	(F)1.580261,		
};

	/*-----------------------------------------------*/
	/* undo_win[i] = 1/tri_win[79-i] * 2^13 ;; N=128 */
	/*                i = 0,1,2,...39                */
	/*-----------------------------------------------*/

const FLOAT undo_win_flt[OLP_SIZE] =
{
	(F)1.599976,	(F)1.620239,	(F)1.640991,	(F)1.662354,	
	(F)1.684204,	(F)1.706665,	(F)1.729736,	(F)1.753418,	
	(F)1.777832,	(F)1.802856,	(F)1.828613,	(F)1.855103,	
	(F)1.882324,	(F)1.910400,	(F)1.939453,	(F)1.969238,	
	(F)2.000000,	(F)2.031738,	(F)2.064575,	(F)2.098389,	
	(F)2.133301,	(F)2.169434,	(F)2.206909,	(F)2.245605,	
	(F)2.285767,	(F)2.327271,	(F)2.370361,	(F)2.415039,	
	(F)2.461548,	(F)2.509766,	(F)2.560059,	(F)2.612305,	
	(F)2.666626,	(F)2.723389,	(F)2.782593,	(F)2.844482,	
	(F)2.909058,	(F)2.976685,	(F)3.047607,	(F)3.121948,	
};

#endif
    /*---------------------------------------------------*/
	/* undo_plus_tri_win_ola[i]                          */
	/*   = 1/tri_win[39-i] * {1-i/39} ;; N=128			 */
    /*          i = 0,1,2...39                           */
	/*---------------------------------------------------*/

const FLOAT undo_plus_tri_win_ola_flt[OLP_SIZE] =
{
	(F)3.200000,	(F)3.197891,	(F)3.195682,	(F)3.193342,	
	(F)3.190883,	(F)3.188272,	(F)3.185520,	(F)3.182589,	
	(F)3.179487,	(F)3.176172,	(F)3.172650,	(F)3.168870,	
	(F)3.164835,	(F)3.160486,	(F)3.155819,	(F)3.150761,	
	(F)3.145299,	(F)3.139345,	(F)3.132867,	(F)3.125753,	
	(F)3.117949,	(F)3.109301,	(F)3.099715,	(F)3.088978,	
	(F)3.076923,	(F)3.063235,	(F)3.047619,	(F)3.029571,	
	(F)3.008547,	(F)2.983666,	(F)2.953846,	(F)2.917358,	
	(F)2.871795,	(F)2.813161,	(F)2.735043,	(F)2.625607,	
	(F)2.461538,	(F)2.187988,	(F)1.641026,	(F)0.000000	
};
#endif